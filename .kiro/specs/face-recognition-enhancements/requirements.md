# Requirements Document

## Introduction

This document outlines the requirements for enhancing the Face Recognition AI Service to improve accuracy, robustness, and user experience. The enhancements are inspired by modern face recognition systems like iPhone Face ID, focusing on multi-angle enrollment, quality-aware processing, and intelligent matching strategies.

## Glossary

- **Face_Recognition_System**: The AI service responsible for face detection, encoding generation, and identity matching
- **Embedding**: A 512-dimensional vector representation of a face generated by the InsightFace model
- **Centroid_Embedding**: The average of multiple embeddings for a single user, providing a more robust representation
- **Quality_Score**: A numerical measure (0.0-1.0) indicating the quality of a face image based on factors like sharpness, lighting, and face visibility
- **Pose_Angle**: The orientation of a face relative to the camera (yaw, pitch, roll)
- **Enrollment_Session**: A guided process where a user captures multiple face images from different angles
- **Recognition_Confidence**: A score indicating how certain the system is about a match

## Requirements

### Requirement 1

**User Story:** As an administrator, I want to enroll students with multiple face images from different angles, so that the system can recognize them accurately in various poses.

#### Acceptance Criteria

1. WHEN an administrator initiates face enrollment for a student THEN the Face_Recognition_System SHALL guide capture of images from at least 5 distinct pose angles (front, left-30째, right-30째, up-15째, down-15째)
2. WHEN a face image is captured during enrollment THEN the Face_Recognition_System SHALL detect the pose angle and classify it into one of the required angle categories
3. WHEN all required pose angles have been captured THEN the Face_Recognition_System SHALL indicate enrollment completion with a success status
4. WHEN fewer than 3 distinct pose angles are captured THEN the Face_Recognition_System SHALL reject the enrollment and request additional images
5. WHERE the enrollment UI is available THEN the Face_Recognition_System SHALL display real-time pose guidance showing which angles are still needed

### Requirement 2

**User Story:** As the system, I want to validate image quality before accepting enrollment images, so that only high-quality face data is stored.

#### Acceptance Criteria

1. WHEN a face image is submitted for enrollment THEN the Face_Recognition_System SHALL compute a quality score based on sharpness, lighting uniformity, and face visibility
2. WHEN the computed quality score is below 0.6 THEN the Face_Recognition_System SHALL reject the image and return a specific rejection reason
3. WHEN a face occupies less than 10% of the image area THEN the Face_Recognition_System SHALL reject the image with message indicating face is too small
4. WHEN face detection confidence is below 0.7 THEN the Face_Recognition_System SHALL reject the image with message indicating unclear face detection
5. WHEN multiple faces are detected in an enrollment image THEN the Face_Recognition_System SHALL reject the image and request a single-face image

### Requirement 3

**User Story:** As the system, I want to use aggregated embeddings for matching, so that recognition is more robust against pose and lighting variations.

#### Acceptance Criteria

1. WHEN a user has multiple enrolled embeddings THEN the Face_Recognition_System SHALL compute and store a centroid embedding as the L2-normalized average of all embeddings
2. WHEN a new embedding is enrolled for a user THEN the Face_Recognition_System SHALL recompute the centroid embedding to include the new data
3. WHEN performing face recognition THEN the Face_Recognition_System SHALL compare the query embedding against both individual embeddings and the centroid embedding
4. WHEN the centroid match distance is lower than the best individual match distance THEN the Face_Recognition_System SHALL use the centroid distance for the final match decision
5. WHEN an embedding is deleted for a user THEN the Face_Recognition_System SHALL recompute the centroid embedding excluding the deleted data

### Requirement 4

**User Story:** As the system, I want to prevent duplicate or redundant enrollments, so that storage is efficient and matching performance is optimized.

#### Acceptance Criteria

1. WHEN a new face image is submitted for enrollment THEN the Face_Recognition_System SHALL compare it against existing embeddings for the same user
2. WHEN the new embedding has cosine distance less than 0.15 from any existing embedding for the same user THEN the Face_Recognition_System SHALL reject it as a duplicate
3. WHEN a user attempts to enroll more than 10 face images THEN the Face_Recognition_System SHALL reject additional enrollments and suggest removing low-quality existing images
4. WHEN enrollment is rejected as duplicate THEN the Face_Recognition_System SHALL return a message indicating the image is too similar to existing enrollment

### Requirement 5

**User Story:** As the system, I want to use adaptive confidence thresholds based on enrollment quality, so that users with better enrollment data get more accurate recognition.

#### Acceptance Criteria

1. WHEN a user has 5 or more high-quality enrollments (quality score > 0.8) THEN the Face_Recognition_System SHALL use a stricter match threshold of 0.35
2. WHEN a user has fewer than 3 enrollments THEN the Face_Recognition_System SHALL use a relaxed match threshold of 0.45
3. WHEN computing match confidence THEN the Face_Recognition_System SHALL factor in the enrollment quality score of the matched user
4. WHEN the enrollment quality variance for a user exceeds 0.2 THEN the Face_Recognition_System SHALL flag the user for re-enrollment recommendation

### Requirement 6

**User Story:** As the system, I want to optionally update embeddings from high-confidence recognitions, so that the model adapts to gradual appearance changes.

#### Acceptance Criteria

1. WHERE adaptive learning is enabled THEN WHEN a recognition match has confidence above 0.95 THEN the Face_Recognition_System SHALL store the new embedding as a candidate for inclusion
2. WHERE adaptive learning is enabled THEN WHEN 3 consecutive high-confidence matches produce similar candidate embeddings THEN the Face_Recognition_System SHALL add the averaged candidate to the user's enrollment set
3. WHERE adaptive learning is enabled THEN WHEN adding an adaptive embedding would exceed the 10-embedding limit THEN the Face_Recognition_System SHALL replace the oldest low-quality embedding
4. WHEN adaptive learning adds a new embedding THEN the Face_Recognition_System SHALL log the event with timestamp and confidence score for audit purposes
5. WHERE adaptive learning is disabled THEN the Face_Recognition_System SHALL not modify enrollment data based on recognition results

### Requirement 7

**User Story:** As an administrator, I want to view enrollment quality metrics for students, so that I can identify students who need re-enrollment.

#### Acceptance Criteria

1. WHEN an administrator requests enrollment status for a user THEN the Face_Recognition_System SHALL return the count of enrollments, average quality score, and pose angle coverage
2. WHEN a user's average enrollment quality is below 0.7 THEN the Face_Recognition_System SHALL flag the user as needing re-enrollment
3. WHEN a user is missing more than 2 of the 5 recommended pose angles THEN the Face_Recognition_System SHALL indicate incomplete pose coverage in the status response
4. WHEN displaying enrollment metrics THEN the Face_Recognition_System SHALL include the date of last enrollment update

### Requirement 8

**User Story:** As the system, I want to detect and reject spoofing attempts using photos, so that attendance cannot be faked.

#### Acceptance Criteria

1. WHERE liveness detection is enabled THEN WHEN a face is detected THEN the Face_Recognition_System SHALL perform basic liveness checks using texture analysis
2. WHERE liveness detection is enabled THEN WHEN the liveness score is below 0.5 THEN the Face_Recognition_System SHALL reject the recognition attempt with message indicating possible spoofing
3. WHERE liveness detection is enabled THEN WHEN processing enrollment images THEN the Face_Recognition_System SHALL require liveness verification for at least 2 of the enrolled images
4. WHEN a spoofing attempt is detected THEN the Face_Recognition_System SHALL log the event with image metadata for security review
5. WHERE liveness detection is disabled THEN the Face_Recognition_System SHALL process images without liveness verification

